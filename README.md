# Jenkinsfile README (Jenkinsfile-5)

## Обзор
Этот Jenkinsfile описывает CI/CD-пайплайн для сборки, тестирования и развертывания приложения Spring Petclinic. Пайплайн включает этапы: получение исходного кода, сборка Maven, тестирование, анализ SonarQube, создание Docker-образа, сканирование уязвимостей с помощью Trivy и отправка образа в Docker-репозиторий.

## Требования
Перед использованием этого пайплайна убедитесь, что в вашем окружении Jenkins настроено следующее:

1. **Инструменты**:
   - Maven ("maven3") установлен и настроен в Jenkins
   - Docker установлен на агентах Jenkins
   - Trivy установлен для сканирования уязвимостей

2. **Учетные данные**:
   - `github-token` - Учетные данные для доступа к репозиторию GitHub
   - `sonarqube-token` - Учетные данные для аутентификации в SonarQube
   - `nexus-token` - Учетные данные для Docker-репозитория (в данном случае Nexus)

3. **Переменные окружения**:
   - `DOCKER_REPO` установлен в "registry.home-local.site" (можно изменить)
   - Должны быть доступны образы Maven и Docker, используемые в пайплайне

## Этапы пайплайна

### 1. Копирование SCM
- Забирает исходный код из репозитория GitHub с использованием указанных учетных данных
- Использует ветку `main`

### 2. Сборка Maven
- Запускается в Docker-контейнере с Maven 3.9.0 и Java 17
- Собирает приложение командой `mvn package`
- Пропускает тесты и проверку стиля на этом этапе

### 3. Запуск тестов
- Выполняет тесты командой `mvn test`
- Пропускает проверку стиля во время тестирования

### 4. Анализ SonarQube
- Выполняет статический анализ кода с помощью SonarQube
- Использует учетные данные `sonarqube-token`
- Ожидает результаты quality gate

### 5. Quality Gate
- Ожидает до 1 часа результатов quality gate от SonarQube
- Прерывает пайплайн, если quality gate не пройден

### 6. Сборка образа
- Собирает Docker-образ со следующей схемой именования:
  - `${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG}`
  - Где `IMAGE_TAG` имеет вид `1.0.0-${BUILD_NUMBER}`

### 7. Сканирование Trivy
- Сканирует собранный Docker-образ на уязвимости с помощью Trivy
- Выводит результаты сканирования в консоль
- В текущей версии только регистрирует уязвимости (не прерывает сборку)

### 8. Отправка образа в DockerHub
- Отправляет Docker-образ в указанный репозиторий
- Отправляет как версионный тег, так и тег `latest`
- Использует учетные данные `nexus-token` для аутентификации

## Действия после сборки
- Всегда архивирует результаты JUnit-тестов и артефакты сборки
- Сохраняет отчеты surefire и сгенерированные JAR-файлы

## Примечания
- В текущей версии пайплайн пропускает проверку стиля во время сборки (`-Dcheckstyle.skip`)
- Сборка Maven выполняется в Docker-контейнере, другие этапы - на основном агенте
- При необходимости можно добавить дополнительные этапы проверки безопасности или развертывания
